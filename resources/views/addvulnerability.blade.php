@extends('layouts.app')

@section('content')
<style>
.autocomplete {
  position: relative;
  display: inline-block;
}

.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: 1px;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 0;
  right: 0;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff; 
  border-bottom: 1px solid #d4d4d4; 
}

/*when hovering an item:*/
.autocomplete-items div:hover {
  background-color: #e9e9e9; 
}

/*when navigating through the items using the arrow keys:*/
.autocomplete-active {
  background-color: DodgerBlue !important; 
  color: #ffffff; 
}
</style>
<script>
function autocomplete2() {
	inp=document.getElementById("VulnerabilityTemplate");
	
              closeAllLists();
      a = document.createElement("DIV");
      a.setAttribute("id", this.id + "autocomplete-list");
      a.setAttribute("class", "autocomplete-items");
      inp.parentNode.appendChild(a);
	  
		$.post("{{ route('CVELookup') }}",
		{
			"query": inp.value,
			"_token": "{{ csrf_token() }}"
		},
		function(data, status){
		JSONData=JSON.parse(data);
		for(i=0;i<JSONData.Entries.length;i++){
          b = document.createElement("DIV");
          /*make the matching letters bold:*/
          b.innerHTML = JSONData.Entries[i].Name+ " - " +JSONData.Entries[i].Description;
          /*insert a input field that will hold the current array item's value:*/
          b.innerHTML += "<input type='hidden' value='" + i + "'>";
          /*execute a function when someone clicks on the item value (DIV element):*/
          b.addEventListener("click", function(e) {
              /*insert the value for the autocomplete text field:*/
              var Template=JSONData.Entries[this.getElementsByTagName("input")[0].value];
			  document.getElementById("Name").value=Template.Name;
			  document.getElementById("CVE").value=Template.CVE;
			  document.getElementById("Classification").value=Template.Classification;
			  UpdateClassification();
			  document.getElementById("Description").value=Template.Description;
			  document.getElementById("References").value=Template.References;
			  document.getElementById("Confidentiality").checked=(Template.Confidentiality==1)?true:false;
			  document.getElementById("Availability").checked=(Template.Availability==1)?true:false;
			  document.getElementById("Integrity").checked=(Template.Integrity==1)?true:false;
              /*close the list of autocompleted values,
              (or any other open lists of autocompleted values:*/
              closeAllLists();
          });
		  b.style.borderBottom ="1px solid #000000";;
          a.appendChild(b);
		}
  });
  function addActive(x) {
    if (!x) return false;
    removeActive(x);
    if (currentFocus >= x.length) currentFocus = 0;
    if (currentFocus < 0) currentFocus = (x.length - 1);
    x[currentFocus].classList.add("autocomplete-active");
  }
  function removeActive(x) {
    for (var i = 0; i < x.length; i++) {
      x[i].classList.remove("autocomplete-active");
    }
  }
  function closeAllLists(elmnt) {
    var x = document.getElementsByClassName("autocomplete-items");
    for (var i = 0; i < x.length; i++) {
      if (elmnt != x[i] && elmnt != inp) {
        x[i].parentNode.removeChild(x[i]);
      }
    }
  }
  document.addEventListener("click", function (e) {
      closeAllLists(e.target);
  });
}

function CancelVulnerability(){
	r=confirm("Are You sure you want to cancel?")
	if(r){
		window.location='../ViewService/{{$Service->id}}'
	}
}
</script>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
			<h2 onclick="javascript:window.location='../ViewService/{{$Service->id}}'">{{$Service->name}} {{$Service->port}}</h2>
            <div class="card">
                <div class="card-header">Vulnerability</div>
				
                <div class="card-body">
					<div class="form-group">
						<label for="VulnerabilityTemplate">Vulnerability Template</label>
						<input type=text class=form-control id=VulnerabilityTemplate Name=VulnerabilityTemplate onkeypress="javascript:autocomplete2()"/>
					</div>
					<form action="{{route('SaveVulnerability')}}" method=post>
					
    {{ csrf_field() }} 
	<input type=hidden name=service value="{{$Service->id}}">
				<span id="Vulnerability Information">
					
				@component('vulnerabiltyform',['Service'=>$Service])
				@endcomponent
				</span>
			<input type=submit class="btn btn-primary" value="Save" /> <input type=button class="btn btn-danger" value="Cancel" onclick="javascript:CancelVulnerability()" />
                </div>
            </div>
        </div>
    </div>
</div>

@endsection
