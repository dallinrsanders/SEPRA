@extends('layouts.app')

@section('content')
<style>
.autocomplete {
  position: relative;
  display: inline-block;
}

.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: 1px;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 0;
  right: 0;
}

.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff; 
  border-bottom: 1px solid #d4d4d4; 
}

/*when hovering an item:*/
.autocomplete-items div:hover {
  background-color: #e9e9e9; 
}

/*when navigating through the items using the arrow keys:*/
.autocomplete-active {
  background-color: DodgerBlue !important; 
  color: #ffffff; 
}
</style>
<script>
function LoadFields(){
	Name="{{$Vulnerability->name}}";
	CVE="{{$Vulnerability->cve}}";
	Classification="{{$Vulnerability->classification}}";
	EaseOfResolution="{{$Vulnerability->easeofresolution}}";
	Description=<?php echo json_encode($Vulnerability->description)?>;
	References=<?php echo json_encode($Vulnerability->reference);?>;
		
	Resolution=<?php echo json_encode($Vulnerability->resolution);?>;
	Policy=<?php echo json_encode($Vulnerability->policyviolation);?>;
	Confidentiality="{{$Vulnerability->confidentiality}}";
	Integrity="{{$Vulnerability->integrity}}";
	Availability="{{$Vulnerability->availability}}";
	Data=<?php echo json_encode($Vulnerability->data);?>;
	@if($Vulnerability->service->website==1)
		Request=<?php echo json_encode($Vulnerability->request);?>;
		Response=<?php echo json_encode($Vulnerability->response);?>;
		Method="{{$Vulnerability->method}}";
		ParamNames="{{$Vulnerability->paramname}}";
		ParamValues="{{$Vulnerability->params}}";
		Path="{{$Vulnerability->path}}";
		StatusCode="{{$Vulnerability->statuscode}}";
		Query="{{$Vulnerability->query}}";
		Website="{{$Vulnerability->website}}";
		document.getElementById("Request").value=Request;
		document.getElementById("Response").value=Response;
		document.getElementById("Method").value=Method;
		document.getElementById("ParamNames").value=ParamNames;
		document.getElementById("ParamValues").value=ParamValues;
		document.getElementById("Path").value=Path;
		document.getElementById("StatusCode").value=StatusCode;
		document.getElementById("Query").value=Query;
		document.getElementById("Website").value=Website;
	@endif
		document.getElementById("Name").value=Name;
		document.getElementById("CVE").value=CVE;
		document.getElementById("Classification").value=Classification;
		UpdateClassification();
		document.getElementById("EaseOfResolution").options.selectedIndex=EaseOfResolution;
		document.getElementById("Description").value=Description;
		document.getElementById("References").value=References;
		document.getElementById("Resolution").value=Resolution;
		document.getElementById("Policy").value=Policy;
		document.getElementById("Confidentiality").checked=(Confidentiality==1)?true:false;
		document.getElementById("Integrity").checked=(Integrity==1)?true:false;
		document.getElementById("Availability").checked=(Availability==1)?true:false;
		document.getElementById("Data").value=Data;
}
function LoadFields2(){
	setTimeout(function(){LoadFields()},1000);
}
function DeleteVulnerability(){
	r=confirm("Are You sure you want to delete this vulnerability?")
	if(r){
		window.location='../DeleteVulnerability/{{$Vulnerability->id}}'
	}
}
function UploadFile(){
	document.getElementById("file").value=null;
	
	$('#UploadFileModal').modal('show')
}
function SaveUpload(){
	var formData = new FormData();
	formData.append('file', $('#file')[0].files[0]);
	formData.append('id',"{{$Vulnerability->id}}");
	formData.append('_token',"{{ csrf_token() }}");

	$.ajax({
       url : '{{route("UploadVulnerabilityFile")}}',
       type : 'POST',
       data : formData,
       processData: false,  // tell jQuery not to process the data
       contentType: false,  // tell jQuery not to set contentType
       success : function(data) {
		   JSONdata=JSON.parse(data);
		   TableRow = document.createElement("tr");
		   TableColumn1 = document.createElement("td");
		   TableColumn2 = document.createElement("td");
		   TableColumn1.innerHTML=JSONdata.name;
		   TableColumn2.innerHTML="<input type=button class=\"btn btn-primary\" value=\"Download\" onclick=\"window.location='../DownloadFile/"+JSONdata.uploadid+"'\"> <input type=button class=\"btn btn-danger\" value=\"Delete\" onclick=\"javascript:DeleteFile("+JSONdata.id+",this)\"> ";
		   TableRow.append(TableColumn1);
		   TableRow.append(TableColumn2);
		   document.getElementById("UploadedFile").append(TableRow);
	$('#UploadFileModal').modal('hide')
       }
	});
}
function DeleteFile(id,input){
	r=confirm("Are you sure you want to delete this file?")
	if(r){
	ThisTableRow=input.parentElement.parentElement
	ThisTableRow.parentElement.removeChild(ThisTableRow);
	$.post("{{ route('DeleteVulnerabilityFile') }}",
  {
	"id": id,
	"_token": "{{ csrf_token() }}"
  },
  function(data, status){
	  
  });
	}
	
}
</script>
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-8">
			<h2 onclick="javascript:window.location='../ViewService/{{$Vulnerability->service->id}}'">{{$Vulnerability->name}} {{$Vulnerability->service->port}}</h2>
            <div class="card">
                <div class="card-header">Vulnerability</div>
				
                <div class="card-body">
					<form action="{{route('EditVulnerability')}}" method=post>
					<input type=hidden id=id name=id value="{{$Vulnerability->id}}" />
    {{ csrf_field() }} 
				<span id="Vulnerability Information">
					
				@component('vulnerabiltyform',['Service'=>$Vulnerability->service])
				@endcomponent
				</span>
				<table id=UploadedFile class="table table-striped">
				<tr><th>File</th><th></th></tr>
				@foreach($Vulnerability->vulnfile as $ThisFile)
					<tr><td>{{$ThisFile->upload->name}}</td>
						<td><input type=button class="btn btn-primary" value="Download" onclick="window.location='../DownloadFile/{{$ThisFile->upload_id}}'"> 
						<input type=button class="btn btn-danger" value="Delete" onclick="javascript:DeleteFile({{$ThisFile->id}},this)"> </td></tr>
				@endforeach
				</table>
				<input type=button class="btn btn-success" value="Upload File" onclick="UploadFile()"><br><br>
			<input type=submit class="btn btn-primary" value="Save" /> <input type=button class="btn btn-danger" value="Delete" onclick="javascript:DeleteVulnerability()" />
                </div>
            </div>
        </div>
    </div>
</div>
<script>
window.onload=LoadFields2();
</script>

<div class="modal" tabindex="-1" role="dialog" id='UploadFileModal'>
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Upload File</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
	  <div class="form-group">
	  <label for="EditName">File</label>
	  <input type=file class=form-control id="file" name="file">
	  </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" onclick="javascript:SaveUpload()">Save changes</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
@endsection
